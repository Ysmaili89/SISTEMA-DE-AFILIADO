# run.py o un archivo similar en la raíz de tu proyecto
from app import create_app
from extensions import db
from models import User
from werkzeug.security import generate_password_hash

# --- Configura un nombre de usuario y contraseña para el nuevo administrador ---
ADMIN_USERNAME = 'administrador'
ADMIN_PASSWORD = 'adminpass'  # CAMBIA ESTO por una contraseña segura

# Inicializa la aplicación
app = create_app()

with app.app_context():
    print("Verificando si el usuario administrador ya existe...")
    
    # Busca un usuario existente con el nombre de administrador
    admin_user = User.query.filter_by(username=ADMIN_USERNAME).first()

    if admin_user:
        print(f"El usuario '{ADMIN_USERNAME}' ya existe. Actualizando contraseña y permisos...")
        admin_user.password_hash = generate_password_hash(ADMIN_PASSWORD)
        admin_user.is_admin = True
        db.session.commit()
        print(f"Usuario '{ADMIN_USERNAME}' actualizado exitosamente.")
    else:
        print(f"Creando nuevo usuario administrador '{ADMIN_USERNAME}'...")
        
        # Crea un nuevo usuario
        new_admin = User(username=ADMIN_USERNAME, is_admin=True)
        # Hashea la contraseña y la asigna al campo password_hash
        new_admin.password_hash = generate_password_hash(ADMIN_PASSWORD)
        
        db.session.add(new_admin)
        db.session.commit()
        print(f"Usuario '{ADMIN_USERNAME}' creado exitosamente con permisos de administrador.")
    print("Script terminado.")